{{ use('bubasuma/simplechat/ConversationWidget') }}
{{ use('bubasuma/simplechat/MessageWidget') }}

{% set asset = register_asset_bundle('bubasuma/simplechat/ChatAsset', true) %}

{{ set(this, 'params', this.params|merge({'user': user})) }}
{{ set(this, 'params', this.params|merge({'users': users})) }}

<div class="row">
    <div class="loading" style="display: none">Loading&#8230;</div>
    {% set conversation = conversation_widget_begin({
        'dataProvider' : conversationDataProvider,
        'itemView' : asset.sourcePath ~ '/tmpl/conversation.twig',
        'options' : {
            'class' : 'conversation-wrap col-lg-3',
            'id' : 'conversations',
        },
        'itemOptions' : {
            'tag' : false
        },
        'user' : {
            'id' : user.id,
            'name' : user.name,
        },
        'current' : {
            'contact' : {
                'id' : contact.id,
                'name' : contact.name,
                'avatar' : contact.avatar,
            },
            'deleteUrl': path('delete-conversation', {'contactId' : contact.id}),
            'readUrl': path('mark-conversation-as-read', {'contactId' : contact.id}),
            'unreadUrl': path('mark-conversation-as-unread', {'contactId' : contact.id}),
        },
        'clientOptions' : {
            'loadUrl' : path('conversations'),
            'templateUrl' : asset.baseurl ~ '/tmpl/conversation.twig',
            'baseUrl' : asset.baseUrl,
            'currentCssClass' : 'current',
            'unreadCssClass' : 'unread',
        }
    })
    %}
    {{ conversation.renderItems|raw }}
    <div id="conversations-loader" style="display: none" class="text-center">
        <img alt="Loading..." src="{{ asset.baseUrl }}/img/inf-square-loader.gif"/>
    </div>
    {{ conversation_widget_end() }}
    {% set message = message_widget_begin({
        'dataProvider' : messageDataProvider,
        'itemView' : asset.sourcePath ~ '/tmpl/message.twig',
        'user' : {
            'id' : user.id,
            'name' : user.name,
            'avatar' : user.avatar,
        },
        'contact' : {
            'id' : contact.id,
            'name' : contact.name,
            'avatar' : contact.avatar,
        },
        'options' : {
            'class' : 'message-wrap col-lg-8',
            'id' : 'messenger',
        },
        'itemOptions' : {
            'tag': false,
        },
        'formOptions' : {
            'action' : path('create-message', {'contactId' : contact.id}),
            'method' : 'post',
        },
        'clientOptions' : {
            'loadUrl' : path('messages', {'contactId' : contact.id}),
            'baseUrl' : asset.baseUrl,
            'templateUrl' : asset.baseurl ~ '/tmpl/message.twig',
            'container' : '#messages',
        }
    })
    %}
    <div id="messages" class="msg-wrap">
        <div id="messages-loader" style="display: none" class="text-center">
            <img alt="Loading..." src="{{ asset.baseUrl }}/img/inf-circle-loader.gif"/>
        </div>
        {% set models = message.dataProvider.models %}
        {% set keys = message.dataProvider.keys %}
        {% set rows = [] %}
        {% set when = false %}
        {% for index, model in models|reverse(true) %}
            {% if when != model.when %}
                {% set when = model.when %}
                {% set rows = rows|merge([html.tag('div', '<strong>' ~ when ~ '</strong>', {'class' : 'alert alert-info msg-date'})]) %}
            {% endif %}
            {% set rows = rows|merge([message.renderItem(model, keys[index], index)]) %}
        {% endfor %}
        {{ rows|join(message.separator)|raw }}
    </div>

    <div class="send-wrap ">
        {{ message.renderForm|raw }}
    </div>
    <div class="btn-panel">
        <a id="msg-send" href="" class=" col-lg-4 text-right btn   send-message-btn pull-right" role="button">
            <i class="fa fa-location-arrow"></i>
            Send Message
        </a>
    </div>
    {{ message_widget_end() }}
</div>